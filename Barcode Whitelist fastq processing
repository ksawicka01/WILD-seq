## This pipeline generates a whitelist of barcodes present in the WILD-seq cell pool. This whitelist is used as a reference for assignment of WILD-seq barcodes in subsequent single cell experiments
# Requires cutadapt. Available from https://cutadapt.readthedocs.io/en/stable/#
# Requires umi_tools. Available from https://umi-tools.readthedocs.io/en/latest/
# RT-PCR is performed as described in Materials and Methods subsection 'Whitelist generation of WILD-seq barcodes' and the fastq files from the sequencing of the PCR products processed using the following pipeline to generate a table of barcodes and associated UMI counts

# The following commands are based on starting from a fastq file called SLX-21864.DNAA001.000000000-KF8JL.s_1.r_1.fq.gz

# Trim reads on the 3'end to remove flanking sequence and adapters
cutadapt -a AGATCGGAAGAGCACACGTCTGAACTCCAGTCAC --discard-untrimmed -o SLX-21864.DNAA001.trimmed.fq.gz  SLX-21864.DNAA001.000000000-KF8JL.s_1.r_1.fq.gz

#Filter read for those that contain the barcode sequence including the common linker sequence and the UMI from the RT primer
zcat SLX-21864.DNAA001.trimmed.fq.gz | egrep -A 2 -B 1 ^[ATGC]{12}TGCATCGGTTAACCGATGCA[ATGC]{12}CGGATAGAACTTTGAATCGCTTG[ATGC]{8}$ | sed '/^--$/d' > SLX-21864.DNAA001.trimmed.filtered.fq

#Extract UMI sequence
umi_tools extract --extract-method=string --3prime --bc-pattern=NNNNNNNN --stdin SLX-21864.DNAA001.trimmed.filtered.fq --log=processed.log --stdout SLX-21864.DNAA001.trimmed.filtered.UMI.fq

# Trim reads on the 5'end to remove flanking sequence and adapters
cutadapt -a CGGATAGAACTTTGAATCGCTTG --discard-untrimmed -o SLX-21864.DNAA001.BC.UMI.fq SLX-21864.DNAA001.trimmed.filtered.UMI.fq

#Parse file for downstream analysis
awk 'BEGIN{RS="@M"}{print $1,"\t",$3}' SLX-21864.DNAA001.BC.UMI.fq | awk -F"\t|_" '{print $2,$3}' | awk -e '$1 ~ /\w/ {print $0}'> SLX-21864.DNAA001.BC.UMI.txt
sort SLX-21864.DNAA001.barcodes.UMI.txt | uniq -c > SLX-21864.DNAA001.barcodes.UMI.counts.txt
